{% extends "includes/layout.html" %}

{% block headAdditions %}
<style>
    .settings-page {
        max-width: 900px;
        margin: 0 auto;
    }

    .settings-header {
        margin-bottom: 2rem;
    }

    .settings-header h1 {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
    }

    .settings-header .subtitle {
        color: var(--text-muted);
    }

    /* Settings Sections */
    .settings-section {
        background: var(--bg-body);
        border-radius: 8px;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        cursor: pointer;
        user-select: none;
        border-bottom: 1px solid var(--border-color);
    }

    .section-header:hover {
        background: rgba(37, 99, 235, 0.05);
    }

    .section-header h2 {
        font-size: 1.1rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-header .section-icon {
        font-size: 1.2rem;
    }

    .section-header .toggle-icon {
        transition: transform 0.2s ease;
    }

    .section-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .section-content {
        padding: 1.5rem;
    }

    .section-content.collapsed {
        display: none;
    }

    .section-description {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
    }

    /* Form Fields */
    .field-group {
        margin-bottom: 1.25rem;
    }

    .field-group:last-child {
        margin-bottom: 0;
    }

    .field-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .field-group .field-help {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .field-group input[type="text"],
    .field-group input[type="password"],
    .field-group input[type="number"],
    .field-group select {
        width: 100%;
        max-width: 400px;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--bg-card);
        color: var(--text-main);
        font-size: 0.95rem;
    }

    .field-group input:focus,
    .field-group select:focus {
        outline: none;
        border-color: var(--color-primary);
    }

    .field-group .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .field-group .checkbox-label input {
        width: auto;
    }

    /* Option Cards (for deployment/hardware) */
    .option-cards {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .option-card {
        flex: 1;
        min-width: 200px;
        max-width: 280px;
        padding: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
    }

    .option-card:hover {
        border-color: var(--color-primary);
    }

    .option-card.selected {
        border-color: var(--color-primary);
        background: rgba(37, 99, 235, 0.1);
    }

    .option-card .card-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .option-card .card-title {
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .option-card .card-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    /* Provider List */
    .provider-list {
        margin-top: 1rem;
    }

    .provider-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: var(--bg-card);
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }

    .provider-item .provider-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .provider-item .provider-name {
        font-weight: 500;
    }

    .provider-item .provider-type {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .provider-item .provider-badges {
        display: flex;
        gap: 0.5rem;
    }

    .badge {
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-primary {
        background: rgba(37, 99, 235, 0.2);
        color: var(--color-primary);
    }

    .badge-enabled {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }

    .badge-disabled {
        background: rgba(108, 117, 125, 0.2);
        color: #6c757d;
    }

    .provider-item .provider-actions {
        display: flex;
        gap: 0.5rem;
    }

    .provider-item .provider-actions button {
        padding: 0.4rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--bg-body);
        color: var(--text-main);
        cursor: pointer;
        font-size: 0.85rem;
    }

    .provider-item .provider-actions button:hover {
        background: var(--bg-card);
    }

    .provider-item .provider-actions button.btn-danger {
        border-color: #dc3545;
        color: #dc3545;
    }

    .provider-item .provider-actions button.btn-danger:hover {
        background: rgba(220, 53, 69, 0.1);
    }

    .add-provider-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
        padding: 1rem;
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        margin-top: 1rem;
        font-size: 0.95rem;
    }

    .add-provider-btn:hover {
        border-color: var(--color-primary);
        color: var(--color-primary);
    }

    /* Worker Connection Info */
    .connection-info {
        background: var(--bg-card);
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }

    .connection-info .info-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .connection-info .info-row:last-child {
        margin-bottom: 0;
    }

    .connection-info .info-label {
        min-width: 150px;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .connection-info .info-value {
        flex: 1;
        font-family: monospace;
        background: var(--bg-body);
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .connection-info .copy-btn {
        padding: 0.4rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--bg-body);
        color: var(--text-main);
        cursor: pointer;
        font-size: 0.8rem;
    }

    .connection-info .copy-btn:hover {
        background: var(--bg-card);
    }

    .connection-info .copy-btn.copied {
        background: rgba(40, 167, 69, 0.2);
        border-color: #28a745;
        color: #28a745;
    }

    /* Save Button */
    .save-bar {
        position: sticky;
        bottom: 0;
        background: var(--bg-body);
        padding: 1rem 1.5rem;
        margin: 2rem -1rem -1rem -1rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .save-bar button {
        padding: 0.6rem 1.5rem;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
    }

    .btn-save {
        background: var(--color-primary);
        border: none;
        color: white;
    }

    .btn-save:hover {
        opacity: 0.9;
    }

    .btn-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.visible {
        display: flex;
    }

    .modal {
        background: var(--bg-body);
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        margin: 0;
    }

    .modal-header .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .modal-footer button {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
    }

    .modal-footer .btn-cancel {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        color: var(--text-main);
    }

    .modal-footer .btn-primary {
        background: var(--color-primary);
        border: none;
        color: white;
    }

    /* Toast notifications */
    .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        background: var(--bg-body);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1001;
        display: none;
    }

    .toast.visible {
        display: block;
        animation: slideIn 0.3s ease;
    }

    .toast.success {
        border-color: #28a745;
    }

    .toast.error {
        border-color: #dc3545;
    }

    @keyframes slideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    /* Test result */
    .test-result {
        margin-top: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .test-result.success {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }

    .test-result.error {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }

    /* Library Checklist */
    .library-checklist {
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 4px;
    }

    .library-checklist-title {
        font-weight: 500;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .library-checklist label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0;
        font-size: 0.9rem;
        cursor: pointer;
    }

    .library-checklist label:hover {
        color: var(--color-primary);
    }

    .library-checklist .library-note {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="settings-header">
        <h1>Settings</h1>
        <p class="subtitle">Configure AudioMuse-AI settings and manage providers</p>
    </div>

    <!-- Providers Section -->
    <div class="settings-section">
        <div class="section-header" onclick="toggleSection(this)">
            <h2><span class="section-icon">&#128230;</span> Media Providers</h2>
            <span class="toggle-icon">&#9660;</span>
        </div>
        <div class="section-content">
            <p class="section-description">
                Configure your music library sources. Multiple providers can share analysis data through file path linking.
            </p>

            <div class="field-group">
                <label for="primary-provider">Primary Provider</label>
                <select id="primary-provider" onchange="markDirty()">
                    <option value="">-- Select Primary --</option>
                </select>
                <div class="field-help">Used by default for API calls without provider specification</div>
            </div>

            <div class="provider-list" id="provider-list">
                <!-- Populated by JS -->
            </div>

            <button class="add-provider-btn" onclick="showAddProviderModal()">
                <span>+</span> Add Provider
            </button>
        </div>
    </div>

    <!-- Deployment Section -->
    <div class="settings-section">
        <div class="section-header" onclick="toggleSection(this)">
            <h2><span class="section-icon">&#9881;</span> Deployment</h2>
            <span class="toggle-icon">&#9660;</span>
        </div>
        <div class="section-content">
            <p class="section-description">
                Configure how AudioMuse-AI is deployed across your infrastructure.
            </p>

            <div class="field-group">
                <label>Deployment Mode</label>
                <div class="option-cards">
                    <div class="option-card selected" data-value="unified" onclick="selectOption(this, 'deployment')">
                        <div class="card-icon">&#128230;</div>
                        <div class="card-title">Unified</div>
                        <div class="card-desc">Server and worker on same machine</div>
                    </div>
                    <div class="option-card" data-value="split" onclick="selectOption(this, 'deployment')">
                        <div class="card-icon">&#128423;</div>
                        <div class="card-title">Split</div>
                        <div class="card-desc">Workers on separate machines</div>
                    </div>
                </div>
            </div>

            <div class="field-group">
                <label>Hardware Type</label>
                <div class="option-cards">
                    <div class="option-card selected" data-value="cpu" onclick="selectOption(this, 'hardware')">
                        <div class="card-icon">&#128187;</div>
                        <div class="card-title">CPU Only</div>
                        <div class="card-desc">Standard processing</div>
                    </div>
                    <div class="option-card" data-value="nvidia" onclick="selectOption(this, 'hardware')">
                        <div class="card-icon">&#9889;</div>
                        <div class="card-title">NVIDIA GPU</div>
                        <div class="card-desc">CUDA acceleration</div>
                    </div>
                </div>
            </div>

            <div id="worker-info" style="display: none;">
                <div class="field-group">
                    <label>Worker Connection Info</label>
                    <div class="field-help">Use these settings when configuring remote workers</div>
                    <div class="connection-info">
                        <div class="info-row">
                            <span class="info-label">Redis URL:</span>
                            <span class="info-value" id="worker-redis-url">redis://localhost:6379/0</span>
                            <button class="copy-btn" onclick="copyValue('worker-redis-url')">Copy</button>
                        </div>
                        <div class="info-row">
                            <span class="info-label">PostgreSQL Host:</span>
                            <span class="info-value" id="worker-postgres-host">localhost</span>
                            <button class="copy-btn" onclick="copyValue('worker-postgres-host')">Copy</button>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Compose File:</span>
                            <span class="info-value" id="worker-compose-file">docker-compose-worker-cpu.yaml</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Section -->
    <div class="settings-section">
        <div class="section-header" onclick="toggleSection(this)">
            <h2><span class="section-icon">&#128202;</span> Analysis</h2>
            <span class="toggle-icon">&#9660;</span>
        </div>
        <div class="section-content">
            <p class="section-description">
                Configure music analysis features and performance options.
            </p>

            <div class="field-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="clap-enabled" checked onchange="markDirty()">
                    <span>Enable CLAP Text Search</span>
                </label>
                <div class="field-help">Search music using natural language. Uses ~750MB additional memory.</div>
            </div>

            <div class="field-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="gpu-clustering" onchange="markDirty()">
                    <span>Use GPU for Clustering</span>
                </label>
                <div class="field-help">Accelerate clustering with NVIDIA RAPIDS cuML. Requires NVIDIA GPU.</div>
            </div>
        </div>
    </div>

    <!-- AI Section -->
    <div class="settings-section">
        <div class="section-header" onclick="toggleSection(this)">
            <h2><span class="section-icon">&#129302;</span> AI Integration</h2>
            <span class="toggle-icon">&#9660;</span>
        </div>
        <div class="section-content">
            <p class="section-description">
                Configure AI providers for creative playlist naming, instant playlists, and other features.
            </p>

            <div class="field-group">
                <label for="ai-provider">AI Provider</label>
                <select id="ai-provider" onchange="updateAiProviderFields(); markDirty()">
                    <option value="NONE">None (Use Default Names)</option>
                    <option value="OLLAMA">Ollama (Local)</option>
                    <option value="OPENAI">OpenAI / OpenRouter</option>
                    <option value="GEMINI">Google Gemini</option>
                    <option value="MISTRAL">Mistral AI</option>
                </select>
                <div class="field-help">AI service for generating creative playlist names and instant playlists</div>
            </div>

            <!-- Provider-specific fields -->
            <div id="ollama-fields" style="display: none;">
                <div class="field-group">
                    <label for="ollama-url">Ollama Server URL</label>
                    <input type="text" id="ollama-url" placeholder="http://localhost:11434/api/generate" onchange="markDirty()">
                    <div class="field-help">URL of your Ollama instance</div>
                </div>
                <div class="field-group">
                    <label for="ollama-model">Ollama Model Name</label>
                    <input type="text" id="ollama-model" placeholder="llama3.1:8b" onchange="markDirty()">
                    <div class="field-help">Model to use for Ollama (e.g., llama3.1:8b, mistral:7b)</div>
                </div>
            </div>

            <div id="openai-fields" style="display: none;">
                <div class="field-group">
                    <label for="openai-url">OpenAI / OpenRouter URL</label>
                    <input type="text" id="openai-url" placeholder="https://api.openai.com/v1/chat/completions" onchange="markDirty()">
                    <div class="field-help">API endpoint URL. Use OpenRouter URL for third-party models.</div>
                </div>
                <div class="field-group">
                    <label for="openai-model">OpenAI Model Name</label>
                    <input type="text" id="openai-model" placeholder="gpt-4" onchange="markDirty()">
                    <div class="field-help">Model name (e.g., gpt-4, gpt-4o, or OpenRouter model IDs)</div>
                </div>
            </div>

            <div id="gemini-fields" style="display: none;">
                <div class="field-group">
                    <label for="gemini-model">Gemini Model Name</label>
                    <input type="text" id="gemini-model" placeholder="gemini-2.5-pro" onchange="markDirty()">
                    <div class="field-help">Google Gemini model (e.g., gemini-2.5-pro, gemini-2.5-flash)</div>
                </div>
            </div>

            <div id="mistral-fields" style="display: none;">
                <div class="field-group">
                    <label for="mistral-model">Mistral Model Name</label>
                    <input type="text" id="mistral-model" placeholder="ministral-3b-latest" onchange="markDirty()">
                    <div class="field-help">Mistral AI model (e.g., ministral-3b-latest, mistral-large-latest)</div>
                </div>
            </div>

            <!-- Instant Playlist Settings -->
            <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1rem; color: var(--text-muted);">Instant Playlist</h3>

            <div class="field-group">
                <label for="max-artist-songs">Max Songs Per Artist</label>
                <input type="number" id="max-artist-songs" min="1" max="50" value="5" onchange="markDirty()">
                <div class="field-help">Maximum songs from a single artist in AI-generated playlists. Lower = more diverse.</div>
            </div>

            <div class="field-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="energy-arc" onchange="markDirty()">
                    <span>Enable Energy Arc</span>
                </label>
                <div class="field-help">Shape playlist energy: gentle start, build to peak, then cool down.</div>
            </div>

            <div class="field-group">
                <label for="ai-timeout">AI Request Timeout (seconds)</label>
                <input type="number" id="ai-timeout" min="30" max="600" value="300" onchange="markDirty()">
                <div class="field-help">Seconds to wait for AI responses. Increase for slower hardware or larger models.</div>
            </div>
        </div>
    </div>

    <!-- Save Bar -->
    <div class="save-bar">
        <button class="btn-save" id="save-btn" onclick="saveSettings()" disabled>Save Changes</button>
    </div>
</div>

<!-- Add/Edit Provider Modal -->
<div class="modal-overlay" id="provider-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modal-title">Add Provider</h3>
            <button class="close-btn" onclick="closeProviderModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="field-group">
                <label for="provider-type">Provider Type</label>
                <select id="provider-type" onchange="updateProviderFields()">
                    <!-- Populated by JS -->
                </select>
            </div>
            <div id="provider-fields">
                <!-- Populated based on provider type -->
            </div>
            <div id="provider-test-result" class="test-result" style="display: none;"></div>
            <div id="provider-library-checklist" class="library-checklist" style="display: none;"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeProviderModal()">Cancel</button>
            <button class="btn-cancel" onclick="testProviderConnection()">Test Connection</button>
            <button class="btn-primary" onclick="saveProvider()">Save Provider</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>
{% endblock %}

{% block bodyAdditions %}
<script src="{{ url_for('static', filename='menu.js') }}"></script>
<script src="/static/utils.js"></script>
<script>
    // State
    let providers = [];
    let providerTypes = [];
    let settings = {};
    let serverInfo = {};
    let isDirty = false;
    let editingProviderId = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
        await Promise.all([
            loadProviders(),
            loadProviderTypes(),
            loadSettings(),
            loadServerInfo()
        ]);
        renderProviders();
        applySettings();
        updateWorkerInfo();
    });

    // Data loading
    async function loadProviders() {
        try {
            const response = await fetch('/api/setup/providers');
            providers = await response.json();
        } catch (err) {
            console.error('Error loading providers:', err);
        }
    }

    async function loadProviderTypes() {
        try {
            const response = await fetch('/api/setup/providers/types');
            providerTypes = await response.json();
        } catch (err) {
            console.error('Error loading provider types:', err);
        }
    }

    async function loadSettings() {
        try {
            const response = await fetch('/api/setup/settings');
            const raw = await response.json();
            // Flatten the category-grouped structure into a simple key-value map.
            // Backend returns: { category: { key: { value, description } } }
            // Frontend expects: { key: value }
            settings = {};
            for (const category of Object.values(raw)) {
                for (const [key, entry] of Object.entries(category)) {
                    settings[key] = entry.value !== undefined ? entry.value : entry;
                }
            }
        } catch (err) {
            console.error('Error loading settings:', err);
        }
    }

    async function loadServerInfo() {
        try {
            const response = await fetch('/api/setup/server-info');
            serverInfo = await response.json();
        } catch (err) {
            console.error('Error loading server info:', err);
        }
    }

    // Rendering
    function renderProviders() {
        const list = document.getElementById('provider-list');
        const primarySelect = document.getElementById('primary-provider');

        list.innerHTML = '';
        primarySelect.innerHTML = '<option value="">-- Select Primary --</option>';

        providers.forEach(p => {
            const typeInfo = providerTypes.find(t => t.type === p.provider_type) || {};
            const isPrimary = settings.primary_provider_id === p.id;

            const item = document.createElement('div');
            item.className = 'provider-item';
            item.innerHTML = `
                <div class="provider-info">
                    <div>
                        <div class="provider-name">${escapeHtml(p.name || typeInfo.name || p.provider_type)}</div>
                        <div class="provider-type">${escapeHtml(typeInfo.name || p.provider_type)}</div>
                    </div>
                    <div class="provider-badges">
                        ${isPrimary ? '<span class="badge badge-primary">Primary</span>' : ''}
                        <span class="badge ${p.enabled ? 'badge-enabled' : 'badge-disabled'}">${p.enabled ? 'Enabled' : 'Disabled'}</span>
                    </div>
                </div>
                <div class="provider-actions">
                    <button onclick="editProvider(${p.id})">Edit</button>
                    <button onclick="toggleProvider(${p.id}, ${!p.enabled})">${p.enabled ? 'Disable' : 'Enable'}</button>
                    <button class="btn-danger" onclick="deleteProvider(${p.id})">Delete</button>
                </div>
            `;
            list.appendChild(item);

            // Add to primary select
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.name || typeInfo.name || p.provider_type;
            if (isPrimary) option.selected = true;
            primarySelect.appendChild(option);
        });

        if (providers.length === 0) {
            list.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No providers configured. Add one to get started.</p>';
        }
    }

    function applySettings() {
        // Deployment - directly select by data-value
        const deploymentValue = settings.deployment_type || 'unified';
        const deploymentCard = document.querySelector(`.option-card[data-value="${deploymentValue}"][onclick*="deployment"]`);
        if (deploymentCard) {
            selectOption(deploymentCard, 'deployment', false);
        }

        // Hardware - directly select by data-value
        const hardwareValue = settings.hardware_type || 'cpu';
        const hardwareCard = document.querySelector(`.option-card[data-value="${hardwareValue}"][onclick*="hardware"]`);
        if (hardwareCard) {
            selectOption(hardwareCard, 'hardware', false);
        }

        // Analysis
        document.getElementById('clap-enabled').checked = settings.clap_enabled !== false;
        document.getElementById('gpu-clustering').checked = settings.gpu_clustering === true;

        // AI Provider
        const aiProvider = document.getElementById('ai-provider');
        if (settings.ai_provider) {
            aiProvider.value = settings.ai_provider;
        }

        // AI Provider Defaults
        if (settings.ollama_server_url) document.getElementById('ollama-url').value = settings.ollama_server_url;
        if (settings.ollama_model_name) document.getElementById('ollama-model').value = settings.ollama_model_name;
        if (settings.openai_server_url) document.getElementById('openai-url').value = settings.openai_server_url;
        if (settings.openai_model_name) document.getElementById('openai-model').value = settings.openai_model_name;
        if (settings.gemini_model_name) document.getElementById('gemini-model').value = settings.gemini_model_name;
        if (settings.mistral_model_name) document.getElementById('mistral-model').value = settings.mistral_model_name;

        // Instant Playlist
        document.getElementById('max-artist-songs').value = settings.max_songs_per_artist_playlist ?? 5;
        document.getElementById('energy-arc').checked = settings.playlist_energy_arc === true;
        document.getElementById('ai-timeout').value = settings.ai_request_timeout ?? 300;

        // Show/hide provider-specific fields
        updateAiProviderFields();

        // Update GPU clustering availability
        updateGpuClusteringState();
    }

    function updateAiProviderFields() {
        const provider = document.getElementById('ai-provider').value;
        document.getElementById('ollama-fields').style.display = provider === 'OLLAMA' ? 'block' : 'none';
        document.getElementById('openai-fields').style.display = provider === 'OPENAI' ? 'block' : 'none';
        document.getElementById('gemini-fields').style.display = provider === 'GEMINI' ? 'block' : 'none';
        document.getElementById('mistral-fields').style.display = provider === 'MISTRAL' ? 'block' : 'none';
    }

    function updateWorkerInfo() {
        const workerInfo = document.getElementById('worker-info');
        const deploymentCards = document.querySelectorAll('.option-card[data-value="unified"], .option-card[data-value="split"]');
        let selectedDeployment = 'unified';
        deploymentCards.forEach(card => {
            if (card.classList.contains('selected')) {
                selectedDeployment = card.dataset.value;
            }
        });

        workerInfo.style.display = selectedDeployment === 'split' ? 'block' : 'none';

        if (selectedDeployment === 'split') {
            const serverIp = serverInfo.host || window.location.hostname;
            const redisPort = serverInfo.redis_port || '6379';

            document.getElementById('worker-redis-url').textContent = `redis://${serverIp}:${redisPort}/0`;
            document.getElementById('worker-postgres-host').textContent = serverIp;

            // Update compose file based on hardware
            const hardwareCards = document.querySelectorAll('.option-card[data-value="cpu"], .option-card[data-value="nvidia"]');
            let selectedHardware = 'cpu';
            hardwareCards.forEach(card => {
                if (card.classList.contains('selected') && (card.dataset.value === 'cpu' || card.dataset.value === 'nvidia')) {
                    selectedHardware = card.dataset.value;
                }
            });

            const composeFile = selectedHardware === 'nvidia'
                ? 'docker-compose-worker-nvidia.yaml'
                : 'docker-compose-worker-cpu.yaml';
            document.getElementById('worker-compose-file').textContent = composeFile;
        }
    }

    function updateGpuClusteringState() {
        const gpuClustering = document.getElementById('gpu-clustering');
        const hardwareCards = document.querySelectorAll('.option-card[data-value="cpu"], .option-card[data-value="nvidia"]');
        let selectedHardware = 'cpu';
        hardwareCards.forEach(card => {
            if (card.classList.contains('selected') && (card.dataset.value === 'cpu' || card.dataset.value === 'nvidia')) {
                selectedHardware = card.dataset.value;
            }
        });

        if (selectedHardware !== 'nvidia') {
            gpuClustering.checked = false;
            gpuClustering.disabled = true;
        } else {
            gpuClustering.disabled = false;
        }
    }

    // UI interactions
    function toggleSection(header) {
        header.classList.toggle('collapsed');
        header.nextElementSibling.classList.toggle('collapsed');
    }

    function selectOption(card, type, markAsDirty = true) {
        const parent = card.parentElement;
        parent.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');

        if (markAsDirty) markDirty();

        if (type === 'deployment') {
            updateWorkerInfo();
        } else if (type === 'hardware') {
            updateGpuClusteringState();
            updateWorkerInfo();
        }
    }

    function markDirty() {
        isDirty = true;
        document.getElementById('save-btn').disabled = false;
    }

    function copyValue(elementId) {
        const element = document.getElementById(elementId);
        navigator.clipboard.writeText(element.textContent).then(() => {
            const btn = element.nextElementSibling;
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            setTimeout(() => {
                btn.textContent = 'Copy';
                btn.classList.remove('copied');
            }, 2000);
        });
    }

    // Provider modal
    function showAddProviderModal() {
        editingProviderId = null;
        document.getElementById('modal-title').textContent = 'Add Provider';

        const typeSelect = document.getElementById('provider-type');
        typeSelect.innerHTML = '';
        providerTypes.forEach(t => {
            const option = document.createElement('option');
            option.value = t.type;
            option.textContent = t.name;
            typeSelect.appendChild(option);
        });

        updateProviderFields();
        document.getElementById('provider-test-result').style.display = 'none';
        const checklistDiv = document.getElementById('provider-library-checklist');
        if (checklistDiv) { checklistDiv.style.display = 'none'; checklistDiv.innerHTML = ''; }
        document.getElementById('provider-modal').classList.add('visible');
    }

    function editProvider(id) {
        editingProviderId = id;
        const provider = providers.find(p => p.id === id);
        if (!provider) return;

        document.getElementById('modal-title').textContent = 'Edit Provider';

        const typeSelect = document.getElementById('provider-type');
        typeSelect.innerHTML = '';
        providerTypes.forEach(t => {
            const option = document.createElement('option');
            option.value = t.type;
            option.textContent = t.name;
            if (t.type === provider.provider_type) option.selected = true;
            typeSelect.appendChild(option);
        });
        typeSelect.disabled = true; // Can't change type when editing

        updateProviderFields(provider.config);
        document.getElementById('provider-test-result').style.display = 'none';
        const checklistDiv = document.getElementById('provider-library-checklist');
        if (checklistDiv) { checklistDiv.style.display = 'none'; checklistDiv.innerHTML = ''; }
        document.getElementById('provider-modal').classList.add('visible');
    }

    function closeProviderModal() {
        document.getElementById('provider-modal').classList.remove('visible');
        document.getElementById('provider-type').disabled = false;
        editingProviderId = null;
        // Reset library checklist
        const checklistDiv = document.getElementById('provider-library-checklist');
        if (checklistDiv) {
            checklistDiv.style.display = 'none';
            checklistDiv.innerHTML = '';
        }
    }

    function updateProviderFields(existingConfig = {}) {
        const type = document.getElementById('provider-type').value;
        const typeInfo = providerTypes.find(t => t.type === type);
        if (!typeInfo) return;

        const container = document.getElementById('provider-fields');
        container.innerHTML = '';

        typeInfo.config_fields.forEach(field => {
            const div = document.createElement('div');
            div.className = 'field-group';

            const value = existingConfig[field.name] || field.default || '';

            let inputHtml = '';
            if (field.type === 'password') {
                inputHtml = `<input type="password" id="field-${field.name}" value="${value}" placeholder="${field.default || ''}">`;
            } else if (field.type === 'boolean') {
                inputHtml = `<label class="checkbox-label"><input type="checkbox" id="field-${field.name}" ${value ? 'checked' : ''}><span>${field.label}</span></label>`;
            } else if (field.type === 'number') {
                inputHtml = `<input type="number" id="field-${field.name}" value="${value}">`;
            } else {
                inputHtml = `<input type="text" id="field-${field.name}" value="${value}" placeholder="${field.default || ''}">`;
            }

            div.innerHTML = `
                ${field.type !== 'boolean' ? `<label for="field-${field.name}">${field.label}${field.required ? ' *' : ''}</label>` : ''}
                ${inputHtml}
                ${field.description ? `<div class="field-help">${field.description}</div>` : ''}
            `;
            container.appendChild(div);
        });
    }

    function collectProviderConfig() {
        const type = document.getElementById('provider-type').value;
        const typeInfo = providerTypes.find(t => t.type === type);
        if (!typeInfo) return {};

        const config = {};
        typeInfo.config_fields.forEach(field => {
            const input = document.getElementById(`field-${field.name}`);
            if (input) {
                if (field.type === 'boolean') {
                    config[field.name] = input.checked;
                } else {
                    config[field.name] = input.value;
                }
            }
        });

        // Collect selected music libraries from checklist
        const libraryCheckboxes = document.querySelectorAll('.library-checkbox');
        if (libraryCheckboxes.length > 0) {
            const allChecked = Array.from(libraryCheckboxes).every(cb => cb.checked);
            if (allChecked) {
                // All checked = no filtering (don't store music_libraries)
            } else {
                const selectedLibraries = [];
                libraryCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        selectedLibraries.push(cb.dataset.libraryName);
                    }
                });
                if (selectedLibraries.length > 0) {
                    config.music_libraries = selectedLibraries;
                }
            }
        }

        return config;
    }

    async function testProviderConnection() {
        const type = document.getElementById('provider-type').value;
        const config = collectProviderConfig();
        const resultDiv = document.getElementById('provider-test-result');

        resultDiv.style.display = 'block';
        resultDiv.className = 'test-result';
        resultDiv.textContent = 'Testing connection...';

        try {
            const response = await fetch('/api/setup/providers/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ provider_type: type, config })
            });
            const data = await response.json();
            resultDiv.className = `test-result ${data.success ? 'success' : 'error'}`;
            resultDiv.textContent = data.message;

            // After successful connection test, fetch available libraries
            if (data.success && type !== 'localfiles') {
                fetchProviderLibraries(type, config);
            }
        } catch (err) {
            resultDiv.className = 'test-result error';
            resultDiv.textContent = 'Connection test failed: ' + err.message;
        }
    }

    async function fetchProviderLibraries(type, config) {
        const checklistDiv = document.getElementById('provider-library-checklist');
        if (!checklistDiv) return;

        try {
            const response = await fetch('/api/setup/providers/libraries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ provider_type: type, config })
            });
            const data = await response.json();
            const libraries = data.libraries || [];

            if (libraries.length === 0) {
                checklistDiv.style.display = 'none';
                return;
            }

            // Get existing music_libraries from editing provider (if any)
            let existingLibraries = null;
            if (editingProviderId) {
                const provider = providers.find(p => p.id === editingProviderId);
                if (provider && provider.config && provider.config.music_libraries) {
                    existingLibraries = provider.config.music_libraries;
                }
            }

            // Render checklist
            let html = '<div class="library-checklist-title">Music Libraries:</div>';
            libraries.forEach(lib => {
                // If editing and provider has music_libraries, check only those
                // Otherwise check all (default = scan everything)
                const isChecked = existingLibraries
                    ? existingLibraries.includes(lib.name)
                    : true;
                html += `<label>
                    <input type="checkbox" ${isChecked ? 'checked' : ''}
                           class="library-checkbox"
                           data-library-name="${lib.name}">
                    ${lib.name}
                </label>`;
            });
            html += '<div class="library-note">Uncheck libraries you don\'t want to scan. All checked = scan everything.</div>';
            checklistDiv.innerHTML = html;
            checklistDiv.style.display = 'block';
        } catch (err) {
            console.error('Error fetching libraries:', err);
        }
    }

    async function saveProvider() {
        const type = document.getElementById('provider-type').value;
        const typeInfo = providerTypes.find(t => t.type === type);
        const config = collectProviderConfig();

        try {
            let response;
            if (editingProviderId) {
                response = await fetch(`/api/setup/providers/${editingProviderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ config })
                });
            } else {
                response = await fetch('/api/setup/providers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider_type: type,
                        name: typeInfo?.name || type,
                        config,
                        enabled: true
                    })
                });
            }

            if (response.ok) {
                closeProviderModal();
                await loadProviders();
                renderProviders();
                showToast('Provider saved successfully', 'success');
            } else {
                const data = await response.json();
                showToast(data.error || 'Failed to save provider', 'error');
            }
        } catch (err) {
            showToast('Error saving provider: ' + err.message, 'error');
        }
    }

    async function toggleProvider(id, enabled) {
        try {
            const response = await fetch(`/api/setup/providers/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled })
            });
            if (response.ok) {
                await loadProviders();
                renderProviders();
                showToast(`Provider ${enabled ? 'enabled' : 'disabled'}`, 'success');
            }
        } catch (err) {
            showToast('Error updating provider', 'error');
        }
    }

    async function deleteProvider(id) {
        if (!confirm('Are you sure you want to delete this provider?')) return;

        try {
            const response = await fetch(`/api/setup/providers/${id}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                await loadProviders();
                renderProviders();
                showToast('Provider deleted', 'success');
            }
        } catch (err) {
            showToast('Error deleting provider', 'error');
        }
    }

    // Save settings
    async function saveSettings() {
        // Collect current values
        const deploymentCards = document.querySelectorAll('.option-card[data-value="unified"], .option-card[data-value="split"]');
        let deploymentType = 'unified';
        deploymentCards.forEach(card => {
            if (card.classList.contains('selected')) {
                deploymentType = card.dataset.value;
            }
        });

        const hardwareCards = document.querySelectorAll('.option-card[data-value="cpu"], .option-card[data-value="nvidia"]');
        let hardwareType = 'cpu';
        hardwareCards.forEach(card => {
            if (card.classList.contains('selected') && (card.dataset.value === 'cpu' || card.dataset.value === 'nvidia')) {
                hardwareType = card.dataset.value;
            }
        });

        const settingsData = {
            deployment_type: deploymentType,
            hardware_type: hardwareType,
            clap_enabled: document.getElementById('clap-enabled').checked,
            gpu_clustering: document.getElementById('gpu-clustering').checked,
            ai_provider: document.getElementById('ai-provider').value,
            // AI Provider Defaults
            ollama_server_url: document.getElementById('ollama-url').value || '',
            ollama_model_name: document.getElementById('ollama-model').value || '',
            openai_server_url: document.getElementById('openai-url').value || '',
            openai_model_name: document.getElementById('openai-model').value || '',
            gemini_model_name: document.getElementById('gemini-model').value || '',
            mistral_model_name: document.getElementById('mistral-model').value || '',
            // Instant Playlist
            max_songs_per_artist_playlist: parseInt(document.getElementById('max-artist-songs').value) || 5,
            playlist_energy_arc: document.getElementById('energy-arc').checked,
            ai_request_timeout: parseInt(document.getElementById('ai-timeout').value) || 300,
        };

        try {
            // Save settings
            const settingsResponse = await fetch('/api/setup/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settingsData)
            });

            // Save primary provider
            const primaryProviderId = document.getElementById('primary-provider').value;
            if (primaryProviderId) {
                await fetch('/api/setup/primary-provider', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider_id: parseInt(primaryProviderId) })
                });
            }

            if (settingsResponse.ok) {
                isDirty = false;
                document.getElementById('save-btn').disabled = true;
                settings = { ...settings, ...settingsData };
                showToast('Settings saved successfully', 'success');
            } else {
                showToast('Failed to save settings', 'error');
            }
        } catch (err) {
            showToast('Error saving settings: ' + err.message, 'error');
        }
    }

    // Toast notifications
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast visible ${type}`;
        setTimeout(() => {
            toast.classList.remove('visible');
        }, 3000);
    }
</script>
{% endblock %}
