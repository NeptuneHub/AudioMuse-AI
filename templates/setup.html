{% extends "includes/layout.html" %}

{% block headAdditions %}
<style>
    .setup-wizard {
        max-width: 800px;
        margin: 0 auto;
    }

    .setup-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .setup-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .setup-header .subtitle {
        color: var(--text-muted);
        font-size: 1.1rem;
    }

    /* Progress Steps */
    .setup-progress {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding: 0 1rem;
    }

    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
    }

    .progress-step:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 15px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: var(--border-color);
        z-index: 0;
    }

    .progress-step.completed:not(:last-child)::after {
        background: var(--primary-color);
    }

    .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--bg-secondary);
        border: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        z-index: 1;
        transition: all 0.3s ease;
    }

    .progress-step.active .step-number {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: white;
    }

    .progress-step.completed .step-number {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: white;
    }

    .step-label {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .progress-step.active .step-label {
        color: var(--text-color);
        font-weight: 500;
    }

    /* Step Content */
    .step-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .step-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .step-section {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .step-section h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        font-size: 1.2rem;
    }

    .step-section p.description {
        color: var(--text-muted);
        margin-bottom: 1rem;
    }

    /* Provider Cards */
    .provider-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1rem;
    }

    .provider-card {
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .provider-card:hover {
        border-color: var(--primary-color);
    }

    .provider-card.selected {
        border-color: var(--primary-color);
        background: rgba(var(--primary-rgb), 0.1);
    }

    .provider-card .provider-name {
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .provider-card .provider-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .provider-card .provider-check {
        display: none;
        color: var(--primary-color);
        font-size: 1.2rem;
    }

    .provider-card.selected .provider-check {
        display: inline;
    }

    /* Provider Config Form */
    .provider-config {
        margin-top: 1.5rem;
        padding: 1rem;
        background: var(--bg-primary);
        border-radius: 8px;
        display: none;
    }

    .provider-config.visible {
        display: block;
    }

    .provider-config h4 {
        margin-top: 0;
        margin-bottom: 1rem;
    }

    .config-field {
        margin-bottom: 1rem;
    }

    .config-field label {
        display: block;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .config-field .field-help {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
    }

    .config-field input,
    .config-field select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--bg-secondary);
        color: var(--text-color);
    }

    .config-field input:focus,
    .config-field select:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    /* Test Connection Button */
    .test-connection-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .test-connection-btn:hover {
        background: var(--bg-primary);
    }

    .test-result {
        margin-top: 0.5rem;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .test-result.success {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }

    .test-result.error {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }

    /* Navigation Buttons */
    .step-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .step-navigation button {
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-prev {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-color);
    }

    .btn-prev:hover {
        background: var(--bg-primary);
    }

    .btn-next, .btn-complete {
        background: var(--primary-color);
        border: none;
        color: white;
    }

    .btn-next:hover, .btn-complete:hover {
        opacity: 0.9;
    }

    .btn-next:disabled, .btn-complete:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Advanced Settings Toggle */
    .advanced-toggle {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-muted);
        margin-top: 1rem;
        padding: 0.5rem 0;
    }

    .advanced-toggle:hover {
        color: var(--text-color);
    }

    .advanced-content {
        display: none;
        margin-top: 1rem;
    }

    .advanced-content.visible {
        display: block;
    }

    /* Hardware Options */
    .hardware-options {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .hardware-option {
        flex: 1;
        padding: 1.5rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
    }

    .hardware-option:hover {
        border-color: var(--primary-color);
    }

    .hardware-option.selected {
        border-color: var(--primary-color);
        background: rgba(var(--primary-rgb), 0.1);
    }

    .hardware-option .option-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .hardware-option .option-name {
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .hardware-option .option-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    /* Summary Section */
    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-label {
        color: var(--text-muted);
    }

    .summary-value {
        font-weight: 500;
    }

    /* Existing Install Banner */
    .existing-install-banner {
        background: rgba(var(--primary-rgb), 0.1);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .existing-install-banner .banner-icon {
        font-size: 1.5rem;
    }

    .existing-install-banner .banner-content h4 {
        margin: 0 0 0.25rem 0;
    }

    .existing-install-banner .banner-content p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    /* Provider List */
    .configured-providers {
        margin-top: 1rem;
    }

    .provider-list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: var(--bg-primary);
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }

    .provider-list-item .provider-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .provider-list-item .provider-status {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .provider-status.enabled {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }

    .provider-status.disabled {
        background: rgba(108, 117, 125, 0.2);
        color: #6c757d;
    }

    .provider-actions {
        display: flex;
        gap: 0.5rem;
    }

    .provider-actions button {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.85rem;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="setup-wizard">
    <div class="setup-header">
        <h1>AudioMuse-AI Setup</h1>
        <p class="subtitle">Configure your music analysis system</p>
    </div>

    <!-- Progress Steps -->
    <div class="setup-progress">
        <div class="progress-step active" data-step="1">
            <div class="step-number">1</div>
            <span class="step-label">Welcome</span>
        </div>
        <div class="progress-step" data-step="2">
            <div class="step-number">2</div>
            <span class="step-label">Providers</span>
        </div>
        <div class="progress-step" data-step="3">
            <div class="step-number">3</div>
            <span class="step-label">Settings</span>
        </div>
        <div class="progress-step" data-step="4">
            <div class="step-number">4</div>
            <span class="step-label">Complete</span>
        </div>
    </div>

    <!-- Step 1: Welcome -->
    <div class="step-content active" id="step-1">
        <div class="step-section">
            <h3>Welcome to AudioMuse-AI</h3>
            <p class="description">
                This setup wizard will help you configure AudioMuse-AI to analyze your music library
                and create intelligent playlists. Let's get started!
            </p>

            <div id="existing-install-info" style="display: none;">
                <!-- Populated by JS if existing installation detected -->
            </div>
        </div>

        <div class="step-section">
            <h3>Select Hardware Configuration</h3>
            <p class="description">
                Choose your hardware setup for music analysis. GPU acceleration significantly speeds up
                the ML analysis process.
            </p>

            <div class="hardware-options">
                <div class="hardware-option selected" data-hardware="cpu">
                    <div class="option-icon">&#128187;</div>
                    <div class="option-name">CPU Only</div>
                    <div class="option-desc">Works on any system. Slower analysis but no special requirements.</div>
                </div>
                <div class="hardware-option" data-hardware="nvidia">
                    <div class="option-icon">&#9889;</div>
                    <div class="option-name">NVIDIA GPU</div>
                    <div class="option-desc">Faster analysis with CUDA acceleration. Requires NVIDIA GPU with drivers.</div>
                </div>
            </div>
        </div>

        <div class="step-navigation">
            <div></div>
            <button class="btn-next" onclick="nextStep()">Continue</button>
        </div>
    </div>

    <!-- Step 2: Provider Configuration -->
    <div class="step-content" id="step-2">
        <div class="step-section">
            <h3>Configure Media Providers</h3>
            <p class="description">
                Select one or more media providers. You can add multiple providers to analyze music
                from different sources. Tracks are linked by file path, so the same song in different
                providers will share analysis data.
            </p>

            <div class="provider-grid" id="provider-grid">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="step-section" id="provider-config-section" style="display: none;">
            <h3 id="provider-config-title">Provider Configuration</h3>
            <div id="provider-configs">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="configured-providers" id="configured-providers" style="display: none;">
            <h3>Configured Providers</h3>
            <div id="provider-list">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="step-navigation">
            <button class="btn-prev" onclick="prevStep()">Back</button>
            <button class="btn-next" onclick="nextStep()" id="btn-step2-next">Continue</button>
        </div>
    </div>

    <!-- Step 3: Advanced Settings -->
    <div class="step-content" id="step-3">
        <div class="step-section">
            <h3>Analysis Settings</h3>
            <p class="description">
                Configure optional analysis features. The defaults work well for most users.
            </p>

            <div class="config-field">
                <label>
                    <input type="checkbox" id="setting-clap-enabled" checked>
                    Enable CLAP Text Search
                </label>
                <div class="field-help">
                    Allows searching your music using natural language queries like "upbeat summer songs".
                    Uses additional memory (~750MB).
                </div>
            </div>

            <div class="config-field">
                <label>
                    <input type="checkbox" id="setting-gpu-clustering">
                    Use GPU for Clustering
                </label>
                <div class="field-help">
                    Accelerate clustering with NVIDIA RAPIDS cuML. Only available with NVIDIA GPU.
                </div>
            </div>
        </div>

        <div class="advanced-toggle" onclick="toggleAdvanced()">
            <span id="advanced-arrow">&#9654;</span>
            <span>Advanced Settings</span>
        </div>

        <div class="advanced-content" id="advanced-settings">
            <div class="step-section">
                <h3>Database Configuration</h3>
                <p class="description">
                    These settings are typically configured via environment variables in Docker.
                    Only change if you know what you're doing.
                </p>

                <div class="config-field">
                    <label for="setting-postgres-host">PostgreSQL Host</label>
                    <input type="text" id="setting-postgres-host" value="postgres" readonly>
                    <div class="field-help">Database host (set via POSTGRES_HOST env var)</div>
                </div>

                <div class="config-field">
                    <label for="setting-redis-url">Redis URL</label>
                    <input type="text" id="setting-redis-url" value="redis://redis:6379/0" readonly>
                    <div class="field-help">Redis connection URL (set via REDIS_URL env var)</div>
                </div>
            </div>

            <div class="step-section">
                <h3>AI Playlist Naming</h3>
                <p class="description">
                    Optionally configure an AI provider for creative playlist names.
                </p>

                <div class="config-field">
                    <label for="setting-ai-provider">AI Provider</label>
                    <select id="setting-ai-provider">
                        <option value="NONE" selected>None (Use Default Names)</option>
                        <option value="OLLAMA">Ollama (Local)</option>
                        <option value="OPENAI">OpenAI / OpenRouter</option>
                        <option value="GEMINI">Google Gemini</option>
                        <option value="MISTRAL">Mistral AI</option>
                    </select>
                    <div class="field-help">AI service for generating creative playlist names</div>
                </div>
            </div>
        </div>

        <div class="step-navigation">
            <button class="btn-prev" onclick="prevStep()">Back</button>
            <button class="btn-next" onclick="nextStep()">Continue</button>
        </div>
    </div>

    <!-- Step 4: Summary & Complete -->
    <div class="step-content" id="step-4">
        <div class="step-section">
            <h3>Setup Summary</h3>
            <p class="description">
                Review your configuration before completing the setup.
            </p>

            <div id="setup-summary">
                <!-- Populated by JS -->
            </div>
        </div>

        <div class="step-section">
            <h3>What's Next?</h3>
            <ul>
                <li>Run the analysis to scan and analyze your music library</li>
                <li>Generate intelligent playlists based on audio fingerprints</li>
                <li>Explore your music with similarity search and visualization tools</li>
            </ul>
        </div>

        <div class="step-navigation">
            <button class="btn-prev" onclick="prevStep()">Back</button>
            <button class="btn-complete" onclick="completeSetup()">Complete Setup</button>
        </div>
    </div>
</div>
{% endblock %}

{% block bodyAdditions %}
<script src="{{ url_for('static', filename='menu.js') }}"></script>
<script>
    // State
    let currentStep = 1;
    let selectedHardware = 'cpu';
    let selectedProviders = [];
    let providerConfigs = {};
    let providerTypes = [];
    let existingProviders = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
        await loadSetupStatus();
        await loadProviderTypes();
        renderProviderGrid();
        setupHardwareOptions();
    });

    async function loadSetupStatus() {
        try {
            const response = await fetch('/api/setup/status');
            const data = await response.json();

            existingProviders = data.providers || [];

            if (data.setup_completed && existingProviders.length > 0) {
                // Show existing installation info
                const info = document.getElementById('existing-install-info');
                info.style.display = 'block';
                info.innerHTML = `
                    <div class="existing-install-banner">
                        <div class="banner-icon">&#9989;</div>
                        <div class="banner-content">
                            <h4>Existing Installation Detected</h4>
                            <p>You have ${existingProviders.length} provider(s) configured.
                               You can modify your settings or add new providers.</p>
                        </div>
                    </div>
                `;
            }
        } catch (err) {
            console.error('Error loading setup status:', err);
        }
    }

    async function loadProviderTypes() {
        try {
            const response = await fetch('/api/setup/providers/types');
            providerTypes = await response.json();
        } catch (err) {
            console.error('Error loading provider types:', err);
        }
    }

    function renderProviderGrid() {
        const grid = document.getElementById('provider-grid');
        grid.innerHTML = '';

        providerTypes.forEach(provider => {
            const isSelected = selectedProviders.includes(provider.type);
            const card = document.createElement('div');
            card.className = `provider-card ${isSelected ? 'selected' : ''}`;
            card.dataset.type = provider.type;
            card.onclick = () => toggleProvider(provider.type);

            card.innerHTML = `
                <div class="provider-name">
                    ${provider.name}
                    <span class="provider-check">&#10003;</span>
                </div>
                <div class="provider-desc">${provider.description}</div>
            `;

            grid.appendChild(card);
        });

        updateProviderConfigSection();
    }

    function toggleProvider(type) {
        const idx = selectedProviders.indexOf(type);
        if (idx >= 0) {
            selectedProviders.splice(idx, 1);
            delete providerConfigs[type];
        } else {
            selectedProviders.push(type);
            providerConfigs[type] = {};
        }
        renderProviderGrid();
    }

    function updateProviderConfigSection() {
        const section = document.getElementById('provider-config-section');
        const configs = document.getElementById('provider-configs');

        if (selectedProviders.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        configs.innerHTML = '';

        selectedProviders.forEach(type => {
            const provider = providerTypes.find(p => p.type === type);
            if (!provider) return;

            const configDiv = document.createElement('div');
            configDiv.className = 'provider-config visible';
            configDiv.innerHTML = `<h4>${provider.name} Configuration</h4>`;

            const form = document.createElement('div');

            provider.config_fields.forEach(field => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'config-field';

                let inputHtml = '';
                if (field.type === 'password') {
                    inputHtml = `<input type="password" id="config-${type}-${field.name}"
                                 placeholder="${field.default || ''}"
                                 data-provider="${type}" data-field="${field.name}">`;
                } else if (field.type === 'boolean') {
                    inputHtml = `<input type="checkbox" id="config-${type}-${field.name}"
                                 ${field.default ? 'checked' : ''}
                                 data-provider="${type}" data-field="${field.name}">`;
                } else if (field.type === 'number') {
                    inputHtml = `<input type="number" id="config-${type}-${field.name}"
                                 value="${field.default || ''}"
                                 data-provider="${type}" data-field="${field.name}">`;
                } else {
                    inputHtml = `<input type="text" id="config-${type}-${field.name}"
                                 value="${field.default || ''}"
                                 placeholder="${field.default || ''}"
                                 data-provider="${type}" data-field="${field.name}">`;
                }

                fieldDiv.innerHTML = `
                    <label for="config-${type}-${field.name}">
                        ${field.label}${field.required ? ' *' : ''}
                    </label>
                    ${inputHtml}
                    <div class="field-help">${field.description || ''}</div>
                `;

                form.appendChild(fieldDiv);
            });

            // Add test connection button
            const testBtn = document.createElement('button');
            testBtn.className = 'test-connection-btn';
            testBtn.innerHTML = '&#128268; Test Connection';
            testBtn.onclick = () => testProviderConnection(type);

            const testResult = document.createElement('div');
            testResult.id = `test-result-${type}`;
            testResult.className = 'test-result';
            testResult.style.display = 'none';

            configDiv.appendChild(form);
            configDiv.appendChild(testBtn);
            configDiv.appendChild(testResult);
            configs.appendChild(configDiv);
        });
    }

    async function testProviderConnection(type) {
        const config = collectProviderConfig(type);
        const resultDiv = document.getElementById(`test-result-${type}`);

        resultDiv.style.display = 'block';
        resultDiv.className = 'test-result';
        resultDiv.textContent = 'Testing connection...';

        try {
            const response = await fetch('/api/setup/providers/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ provider_type: type, config })
            });
            const data = await response.json();

            resultDiv.className = `test-result ${data.success ? 'success' : 'error'}`;
            resultDiv.textContent = data.message;
        } catch (err) {
            resultDiv.className = 'test-result error';
            resultDiv.textContent = 'Connection test failed: ' + err.message;
        }
    }

    function collectProviderConfig(type) {
        const config = {};
        const inputs = document.querySelectorAll(`[data-provider="${type}"]`);
        inputs.forEach(input => {
            const field = input.dataset.field;
            if (input.type === 'checkbox') {
                config[field] = input.checked;
            } else {
                config[field] = input.value;
            }
        });
        return config;
    }

    function collectAllProviderConfigs() {
        selectedProviders.forEach(type => {
            providerConfigs[type] = collectProviderConfig(type);
        });
    }

    function setupHardwareOptions() {
        document.querySelectorAll('.hardware-option').forEach(option => {
            option.onclick = function() {
                document.querySelectorAll('.hardware-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                selectedHardware = this.dataset.hardware;

                // Update GPU clustering option
                const gpuClustering = document.getElementById('setting-gpu-clustering');
                if (selectedHardware === 'nvidia') {
                    gpuClustering.disabled = false;
                } else {
                    gpuClustering.disabled = true;
                    gpuClustering.checked = false;
                }
            };
        });
    }

    function toggleAdvanced() {
        const content = document.getElementById('advanced-settings');
        const arrow = document.getElementById('advanced-arrow');
        content.classList.toggle('visible');
        arrow.innerHTML = content.classList.contains('visible') ? '&#9660;' : '&#9654;';
    }

    function updateProgressSteps() {
        document.querySelectorAll('.progress-step').forEach((step, idx) => {
            const stepNum = idx + 1;
            step.classList.remove('active', 'completed');
            if (stepNum < currentStep) {
                step.classList.add('completed');
            } else if (stepNum === currentStep) {
                step.classList.add('active');
            }
        });
    }

    function showStep(step) {
        document.querySelectorAll('.step-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`step-${step}`).classList.add('active');
        currentStep = step;
        updateProgressSteps();

        if (step === 4) {
            renderSummary();
        }
    }

    function nextStep() {
        if (currentStep === 2) {
            collectAllProviderConfigs();
            if (selectedProviders.length === 0) {
                alert('Please select at least one media provider.');
                return;
            }
        }
        if (currentStep < 4) {
            showStep(currentStep + 1);
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            showStep(currentStep - 1);
        }
    }

    function renderSummary() {
        const summary = document.getElementById('setup-summary');
        const providerNames = selectedProviders.map(type => {
            const p = providerTypes.find(pt => pt.type === type);
            return p ? p.name : type;
        }).join(', ');

        summary.innerHTML = `
            <div class="summary-item">
                <span class="summary-label">Hardware</span>
                <span class="summary-value">${selectedHardware === 'nvidia' ? 'NVIDIA GPU' : 'CPU Only'}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Providers</span>
                <span class="summary-value">${providerNames || 'None selected'}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">CLAP Text Search</span>
                <span class="summary-value">${document.getElementById('setting-clap-enabled').checked ? 'Enabled' : 'Disabled'}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">GPU Clustering</span>
                <span class="summary-value">${document.getElementById('setting-gpu-clustering').checked ? 'Enabled' : 'Disabled'}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">AI Playlist Naming</span>
                <span class="summary-value">${document.getElementById('setting-ai-provider').value}</span>
            </div>
        `;
    }

    async function completeSetup() {
        try {
            // Save providers
            for (const type of selectedProviders) {
                const provider = providerTypes.find(p => p.type === type);
                await fetch('/api/setup/providers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider_type: type,
                        name: provider.name,
                        config: providerConfigs[type],
                        enabled: true,
                        priority: 0
                    })
                });
            }

            // Save settings
            await fetch('/api/setup/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    hardware_type: selectedHardware,
                    clap_enabled: document.getElementById('setting-clap-enabled').checked,
                    gpu_clustering: document.getElementById('setting-gpu-clustering').checked,
                    ai_provider: document.getElementById('setting-ai-provider').value
                })
            });

            // Mark setup as complete
            await fetch('/api/setup/complete', { method: 'POST' });

            // Redirect to home
            alert('Setup complete! Redirecting to the main page...');
            window.location.href = '/';

        } catch (err) {
            console.error('Error completing setup:', err);
            alert('Error saving configuration: ' + err.message);
        }
    }
</script>
{% endblock %}
