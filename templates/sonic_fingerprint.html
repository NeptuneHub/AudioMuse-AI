<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="app-version" content="{{ app_version }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioMuse-AI - Sonic Fingerprint</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='menu.css') }}">
    <style>
        #fingerprint-form button {
            flex-grow: 1;
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            font-size: 1rem;
            margin-top: 1rem;
            background-color: #2563EB;
        }
        #fingerprint-form button:hover {
            background-color: #1D4ED8;
        }
    </style>
</head>
<body>

<div class="page-container">
    <aside class="sidebar">
        <nav>
            <ul class="sidebar-nav">
                {% with %}
                {% set active = 'sonic_fingerprint' %}
                {% include 'sidebar_navi.html' %}
                {% endwith %}
            </ul>
        </nav>
    </aside>

    <div class="main-content" id="main-content">
        <button class="menu-toggle">&#9776;</button>
        <div class="container">
            <section>
                <header class="page-header">
                    <h1>AudioMuse-AI - Sonic Fingerprint</h1>
                    <p>Generate a playlist based on your unique listening habits.</p>
                </header>

                <form id="fingerprint-form">
                    
                    <fieldset>
                        <legend>Your Credentials</legend>
                        <p style="font-size: 0.875rem; color: #4B5563; margin-top: -0.5rem; margin-bottom: 1rem;">
                            Enter your personal credentials to generate a fingerprint from your listening history.
                        </p>
                        <div class="param-group">
                            {% if mediaserver_type == 'jellyfin' %}
                            <div>
                                <label for="jellyfin_user_identifier">Jellyfin Username or User ID:</label>
                                <input type="text" id="jellyfin_user_identifier" name="jellyfin_user_identifier" required placeholder="Enter Jellyfin Username or User ID">
                            </div>
                            <div>
                                <label for="jellyfin_token">API Token:</label>
                                <input type="password" id="jellyfin_token" name="jellyfin_token" placeholder="Optional for default user, specify for other users">
                            </div>
                            {% elif mediaserver_type == 'navidrome' %}
                            <div>
                                <label for="navidrome_user">Navidrome Username:</label>
                                <input type="text" id="navidrome_user" name="navidrome_user" required>
                            </div>
                            <div>
                                <label for="navidrome_password">Password/API Token:</label>
                                <input type="password" id="navidrome_password" name="navidrome_password" placeholder="Optional for default user, specify for other user">
                            </div>
                            {% endif %}
                        </div>
                    </fieldset>

                     <fieldset>
                        <legend>Parameters</legend>
                        <div class="param-group">
                            <div>
                                <label for="n">Number of results:</label>
                                <input type="number" id="n" name="n" value="200" min="40" max="1000">
                            </div>
                        </div>
                    </fieldset>

                    <button type="submit">
                        Generate My Sonic Fingerprint
                    </button>
                </form>
            </section>

            <section id="results-container" class="hidden">
                <h2>Results</h2>
                <div id="status"></div>
                <div id="results-table-wrapper"></div>
            </section>

            <section id="playlist-creator" class="hidden">
                <h3>Create a Playlist from Results</h3>
                <form id="playlist-form">
                    <div class="param-group">
                        <div>
                           <label for="playlist_name">Playlist Name:</label>
                           <input type="text" id="playlist_name" name="playlist_name" required placeholder="e.g., My Sonic Mix">
                        </div>
                    </div>
                    <button type="submit" style="background-color: #16A34A;">
                        Create Playlist on Media Server
                    </button>
                </form>
                <div id="playlist-status"></div>
            </section>
        
        </div>
    </div>
</div>

    <script>
        (() => {
            let currentTrackIds = [];
            const mediaserverType = "{{ mediaserver_type }}";

            const fingerprintForm = document.getElementById('fingerprint-form');
            const playlistForm = document.getElementById('playlist-form');
            const statusDiv = document.getElementById('status');
            const resultsContainer = document.getElementById('results-container');
            const playlistCreator = document.getElementById('playlist-creator');
            const resultsTableWrapper = document.getElementById('results-table-wrapper');
            const playlistStatusDiv = document.getElementById('playlist-status');

            window.addEventListener('DOMContentLoaded', async () => {
                try {
                    const response = await fetch("{{ url_for('sonic_fingerprint_bp.get_media_server_defaults') }}");
                    if (!response.ok) return;
                    
                    const data = await response.json();

                    if (mediaserverType === 'jellyfin' && data.default_user_id) {
                        document.getElementById('jellyfin_user_identifier').value = data.default_user_id;
                    } else if (mediaserverType === 'navidrome' && data.default_user) {
                        document.getElementById('navidrome_user').value = data.default_user;
                    }
                } catch (error) {
                    console.error('Failed to fetch default config:', error);
                }
            });

            fingerprintForm.addEventListener('submit', async function (event) {
                event.preventDefault();

                const payload = {
                    n: parseInt(document.getElementById('n').value, 10)
                };

                if (mediaserverType === 'jellyfin') {
                    payload.jellyfin_user_identifier = document.getElementById('jellyfin_user_identifier').value;
                    payload.jellyfin_token = document.getElementById('jellyfin_token').value;
                    if (!payload.jellyfin_user_identifier) {
                        statusDiv.textContent = 'Jellyfin User Identifier is required.';
                        statusDiv.className = 'status-error';
                        resultsContainer.classList.remove('hidden');
                        return;
                    }
                } else if (mediaserverType === 'navidrome') {
                    payload.navidrome_user = document.getElementById('navidrome_user').value;
                    payload.navidrome_password = document.getElementById('navidrome_password').value;
                     if (!payload.navidrome_user) {
                        statusDiv.textContent = 'Navidrome Username is required.';
                        statusDiv.className = 'status-error';
                        resultsContainer.classList.remove('hidden');
                        return;
                    }
                }

                resultsContainer.classList.remove('hidden');
                playlistCreator.classList.add('hidden');
                statusDiv.textContent = 'Generating your sonic fingerprint... This may take a moment.';
                statusDiv.className = '';
                resultsTableWrapper.innerHTML = '';

                try {
                    const response = await fetch("{{ url_for('sonic_fingerprint_bp.generate_sonic_fingerprint_endpoint') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    
                    if (data.length === 0) {
                        statusDiv.textContent = 'Could not generate fingerprint. No recommendations found. Check credentials and listening history.';
                        statusDiv.className = 'status-error';
                        return;
                    }

                    currentTrackIds = data.map(track => track.item_id);
                    statusDiv.textContent = `Found ${data.length} recommended tracks.`;
                    const tableHTML = `
                        <table>
                            <thead><tr><th>Title</th><th>Artist</th><th>Distance</th></tr></thead>
                            <tbody>
                                ${data.map(track => `
                                    <tr>
                                        <td>${track.title || 'N/A'}</td>
                                        <td>${track.author || 'N/A'}</td>
                                        <td>${track.distance.toFixed(4)}</td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>`;
                    resultsTableWrapper.innerHTML = tableHTML;
                    playlistCreator.classList.remove('hidden');
                    playlistStatusDiv.textContent = '';
                    document.getElementById('playlist_name').value = 'My Sonic Fingerprint Mix';
                } catch (error) {
                    statusDiv.textContent = `Error: ${error.message}`;
                    statusDiv.className = 'status-error';
                }
            });

            playlistForm.addEventListener('submit', async function (event) {
                event.preventDefault();
                const playlistName = document.getElementById('playlist_name').value;
                if (!playlistName) {
                    playlistStatusDiv.textContent = 'Please enter a playlist name.';
                    playlistStatusDiv.className = 'status-error';
                    return;
                }
                if (currentTrackIds.length === 0) {
                    playlistStatusDiv.textContent = 'No tracks to add. Generate a fingerprint first.';
                    playlistStatusDiv.className = 'status-error';
                    return;
                }

                const payload = {
                    playlist_name: playlistName,
                    track_ids: currentTrackIds,
                    user_creds: {}
                };

                if (mediaserverType === 'jellyfin') {
                    payload.user_creds.user_identifier = document.getElementById('jellyfin_user_identifier').value;
                    payload.user_creds.token = document.getElementById('jellyfin_token').value;
                } else if (mediaserverType === 'navidrome') {
                    payload.user_creds.user = document.getElementById('navidrome_user').value;
                    payload.user_creds.password = document.getElementById('navidrome_password').value;
                }

                playlistStatusDiv.textContent = 'Creating playlist...';
                
                try {
                    const response = await fetch("{{ url_for('voyager_bp.create_media_server_playlist') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || `HTTP error! status: ${response.status}`);
                    playlistStatusDiv.textContent = result.message;
                    playlistStatusDiv.className = 'status-success';
                } catch (error) {
                    playlistStatusDiv.textContent = `Error: ${error.message}`;
                    playlistStatusDiv.className = 'status-error';
                }
            });
        })();
    </script>
    <script src="{{ url_for('static', filename='menu.js') }}"></script>
</body>
</html>

