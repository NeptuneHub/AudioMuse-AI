{% extends "includes/layout.html" %}

{% block headAdditions %}
<style>
    /* Existing Styles */
    .param-group {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .param-group>div {
        flex: 1;
        min-width: 200px;
    }

    .slider-container {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .slider-value {
        font-weight: 600;
        color: var(--primary-color, #3B82F6);
    }

    input[type="range"] {
        width: 100%;
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        margin-bottom: 60px; /* Space for player */
    }

    .results-table th,
    .results-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }

    .results-table th {
        background-color: #f3f4f6;
        font-weight: 600;
    }

    .results-table tr:hover {
        background-color: #f9fafb;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-include {
        background-color: #16A34A;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .btn-include:hover {
        background-color: #15803D;
    }

    .btn-exclude {
        background-color: #DC2626;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .btn-exclude:hover {
        background-color: #B91C1C;
    }

    .btn-play {
        background-color: #3B82F6;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
    }

    .btn-play:hover {
        background-color: #2563EB;
    }

    .included-row {
        background-color: #D1FAE5 !important;
    }

    .excluded-row {
        background-color: #FEE2E2 !important;
        opacity: 0.6;
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .status-included {
        background-color: #16A34A;
        color: white;
    }

    .status-excluded {
        background-color: #DC2626;
        color: white;
    }

    .stats-container {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #f3f4f6;
        border-radius: 0.5rem;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #6B7280;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1F2937;
    }

    /* Filter Builder Styles */
    .filter-builder {
        background-color: #1f2937;
        padding: 1.5rem;
        border-radius: 0.5rem;
        color: white;
        margin-bottom: 1.5rem;
    }

    .filter-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .filter-header select {
        background-color: #374151;
        color: white;
        border: 1px solid #4b5563;
        padding: 0.5rem;
        border-radius: 0.375rem;
    }

    .filter-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
    }

    .filter-row select, .filter-row input {
        background-color: #374151;
        color: white;
        border: 1px solid #4b5563;
        padding: 0.5rem;
        border-radius: 0.375rem;
        flex: 1;
        min-width: 150px;
    }

    .btn-add-filter, .btn-remove-filter {
        background: none;
        border: none;
        color: #9ca3af;
        font-size: 1.5rem;
        cursor: pointer;
        line-height: 1;
    }

    .btn-add-filter:hover { color: white; }
    .btn-remove-filter:hover { color: #ef4444; }

    .tab-container {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
    }

    .tab-btn {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 600;
        color: #6b7280;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }

    .tab-btn.active {
        color: var(--primary-color, #3B82F6);
        border-bottom-color: var(--primary-color, #3B82F6);
    }

    /* Sticky Player Styles */
    .sticky-player {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #111827;
        color: white;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 2rem;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        border-top: 1px solid #374151;
    }

    .player-info {
        flex: 0 0 250px;
        overflow: hidden;
        white-space: nowrap;
    }

    .player-title {
        font-weight: 700;
        font-size: 1.1rem;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .player-artist {
        font-size: 0.9rem;
        color: #9ca3af;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .player-controls {
        display: flex;
        flex: 1;
        flex-direction: column;
        gap: 0.5rem;
    }

    .player-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        align-items: center;
    }

    .player-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 1.5rem;
    }

    .player-btn:hover { color: var(--primary-color, #3B82F6); }

    .progress-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.875rem;
        color: #9ca3af;
    }

    .progress-bar {
        flex: 1;
        height: 4px;
        background-color: #374151;
        border-radius: 2px;
        position: relative;
        cursor: pointer;
    }

    .progress-fill {
        height: 100%;
        background-color: var(--primary-color, #3B82F6);
        border-radius: 2px;
        width: 0%;
    }

    /* Hidden class utility */
    .hidden { display: none !important; }

</style>
{% endblock %}

{% block content %}
<section>
    <header class="page-header">
        <h1>AudioMuse-AI - Extend Playlist</h1>
        <p>Create dynamic playlists using existing playlists or Smart Filters, and discover similar tracks.</p>
    </header>

    <!-- Source Selection Tabs -->
    <div class="tab-container">
        <button class="tab-btn active" onclick="switchTab('smart')">Smart Filters</button>
        <button class="tab-btn" onclick="switchTab('playlist')">Existing Playlist</button>
    </div>

    <form id="extend-playlist-form">

        <!-- Smart Filters Section -->
        <div id="smart-filters-section" class="filter-builder">
            <div class="filter-header">
                <span>Match</span>
                <select id="match-mode" name="match_mode">
                    <option value="all">all</option>
                    <option value="any">any</option>
                </select>
                <span>of the following rules:</span>
                <button type="button" class="btn-add-filter" onclick="addFilterRow()">+</button>
            </div>
            <div id="filter-rows">
                <!-- Filter rows will be added here -->
            </div>
        </div>

        <!-- Existing Playlist Section -->
        <div id="playlist-section" class="param-group hidden">
            <div>
                <label for="playlist_select" class="label-with-tooltip">
                    Select Playlist:
                    <span class="info-tooltip" tabindex="0">
                        <span class="info-icon"></span>
                        <span class="tooltip-text">Choose a playlist from your library to extend with similar songs.</span>
                    </span>
                </label>
                <select id="playlist_select" name="playlist_select">
                    <option value="">-- Select a playlist --</option>
                </select>
            </div>
        </div>

        <!-- Common Parameters -->
        <div class="param-group">
            <div>
                <label for="max_songs" class="label-with-tooltip">
                    Maximum Songs:
                    <span class="info-tooltip" tabindex="0">
                        <span class="info-icon"></span>
                        <span class="tooltip-text">Maximum number of similar songs to find.</span>
                    </span>
                </label>
                <input type="number" id="max_songs" name="max_songs" value="50" min="1" max="200">
            </div>
        </div>

        <div class="param-group">
            <div class="slider-container">
                <label for="similarity_threshold" class="label-with-tooltip">
                    Similarity Threshold: <span id="threshold_value" class="slider-value">0.50</span>
                    <span class="info-tooltip" tabindex="0">
                        <span class="info-icon"></span>
                        <span class="tooltip-text">Lower values = more similar songs. Higher values = more diverse results. Range: 0.0 (most similar) to 1.0 (least similar).</span>
                    </span>
                </label>
                <input type="range" id="similarity_threshold" name="similarity_threshold" min="0" max="1" step="0.01" value="0.50">
            </div>
        </div>

        <button type="submit">
            Find Similar Songs
        </button>
    </form>
</section>

<section id="stats-container" class="hidden">
    <div class="stats-container">
        <div class="stat-item">
            <span class="stat-label">Source Songs</span>
            <span id="stat-original" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Included Songs</span>
            <span id="stat-included" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Excluded Songs</span>
            <span id="stat-excluded" class="stat-value">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Suggested Songs</span>
            <span id="stat-suggested" class="stat-value">0</span>
        </div>
    </div>
</section>

<section id="results-container" class="hidden">
    <h2>Similar Songs</h2>
    <div id="status"></div>
    <div id="results-table-wrapper"></div>
</section>

<section id="playlist-creator" class="hidden">
    <h3>Save Extended Playlist</h3>
    <form id="save-playlist-form">
        <div class="param-group">
            <div>
                <label for="new_playlist_name">New Playlist Name:</label>
                <input type="text" id="new_playlist_name" name="new_playlist_name" required placeholder="e.g., My Extended Playlist">
            </div>
        </div>
        <button type="submit" style="background-color: #16A34A;">
            Save Playlist to Media Server
        </button>
    </form>
    <div id="playlist-status"></div>
</section>

<!-- Sticky Web Player -->
<div id="web-player" class="sticky-player hidden">
    <audio id="audio-element"></audio>
    <div class="player-info">
        <div id="player-title" class="player-title">Not Playing</div>
        <div id="player-artist" class="player-artist"></div>
    </div>
    <div class="player-controls">
        <div class="player-buttons">
            <button class="player-btn" onclick="seek(-10)">&#8634;</button>
            <button id="play-pause-btn" class="player-btn" onclick="togglePlay()">&#9658;</button>
            <button class="player-btn" onclick="seek(10)">&#8635;</button>
        </div>
        <div class="progress-container">
            <span id="current-time">0:00</span>
            <div class="progress-bar" onclick="seekTo(event)">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <span id="duration">0:00</span>
        </div>
    </div>
    <div style="flex: 0 0 100px;">
        <!-- Volume or other controls if needed -->
    </div>
</div>

{% endblock %}

{% block bodyAdditions %}
<script src="{{ url_for('static', filename='menu.js') }}"></script>
<script>
    // --- Global Variables ---
    let activeTab = 'smart';
    let includedIds = [];
    let excludedIds = [];
    let playlistStats = { original: 0, included: 0, excluded: 0, suggested: 0 };

    // Fields config
    const filterFields = [
        { value: 'album', label: 'Album Title' },
        { value: 'artist', label: 'Artist' },
        { value: 'title', label: 'Track Title' },
        { value: 'bpm', label: 'BPM' },
        { value: 'energy', label: 'Energy' },
        { value: 'key', label: 'Key' },
        { value: 'scale', label: 'Scale' },
        { value: 'mood', label: 'Mood' }
    ];

    const operators = {
        text: [
            { value: 'contains', label: 'contains' },
            { value: 'does_not_contain', label: 'does not contain' },
            { value: 'is', label: 'is' },
            { value: 'is_not', label: 'is not' }
        ],
        number: [
            { value: 'is', label: 'is' },
            { value: 'greater_than', label: 'is greater than' },
            { value: 'less_than', label: 'is less than' }
        ]
    };

    // --- Initialization ---
    (() => {
        // Load playlists for the select dropdown
        loadPlaylists();

        // Add initial filter row
        addFilterRow();

        // Update threshold display
        document.getElementById('similarity_threshold').addEventListener('input', (e) => {
            document.getElementById('threshold_value').textContent = parseFloat(e.target.value).toFixed(2);
        });

        // Player events
        const audio = document.getElementById('audio-element');
        audio.addEventListener('timeupdate', updateProgress);
        audio.addEventListener('ended', () => {
            document.getElementById('play-pause-btn').innerHTML = '&#9658;';
        });
    })();

    // --- Tab Switching ---
    window.switchTab = function(tab) {
        activeTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        if (tab === 'smart') {
            document.getElementById('smart-filters-section').classList.remove('hidden');
            document.getElementById('playlist-section').classList.add('hidden');
        } else {
            document.getElementById('smart-filters-section').classList.add('hidden');
            document.getElementById('playlist-section').classList.remove('hidden');
        }

        // Reset lists on tab switch
        includedIds = [];
        excludedIds = [];
    };

    // --- Filter Builder Logic ---
    window.addFilterRow = function() {
        const row = document.createElement('div');
        row.className = 'filter-row';

        // Field Select
        const fieldSelect = document.createElement('select');
        fieldSelect.className = 'filter-field';
        filterFields.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.value;
            opt.textContent = f.label;
            fieldSelect.appendChild(opt);
        });

        // Operator Select
        const opSelect = document.createElement('select');
        opSelect.className = 'filter-operator';

        // Value Input
        const valInput = document.createElement('input');
        valInput.type = 'text';
        valInput.className = 'filter-value';

        // Remove Button
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn-remove-filter';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => row.remove();

        // Update operators when field changes
        fieldSelect.onchange = () => updateOperators(fieldSelect, opSelect, valInput);

        row.appendChild(fieldSelect);
        row.appendChild(opSelect);
        row.appendChild(valInput);
        row.appendChild(removeBtn);

        document.getElementById('filter-rows').appendChild(row);
        updateOperators(fieldSelect, opSelect, valInput); // Initialize
    };

    function updateOperators(fieldSelect, opSelect, valInput) {
        const field = fieldSelect.value;
        opSelect.innerHTML = '';
        const ops = (['bpm', 'energy'].includes(field)) ? operators.number : operators.text;

        ops.forEach(op => {
            const opt = document.createElement('option');
            opt.value = op.value;
            opt.textContent = op.label;
            opSelect.appendChild(opt);
        });

        valInput.type = (['bpm', 'energy'].includes(field)) ? 'number' : 'text';
    }

    function getFilters() {
        const rows = document.querySelectorAll('.filter-row');
        const filters = [];
        rows.forEach(row => {
            const field = row.querySelector('.filter-field').value;
            const operator = row.querySelector('.filter-operator').value;
            const value = row.querySelector('.filter-value').value;
            if (value) {
                filters.push({ field, operator, value });
            }
        });
        return filters;
    }

    // --- API Interaction ---
    async function loadPlaylists() {
        try {
            const response = await fetch("{{ url_for('get_playlists_endpoint') }}");
            const playlists = await response.json();
            const select = document.getElementById('playlist_select');
            select.innerHTML = '<option value="">-- Select a playlist --</option>';
            for (const [name, tracks] of Object.entries(playlists)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `${name} (${tracks.length} songs)`;
                select.appendChild(option);
            }
        } catch (error) {
            console.error('Failed to load playlists:', error);
        }
    }

    async function findSimilarSongs() {
        const statusDiv = document.getElementById('status');
        const maxSongs = parseInt(document.getElementById('max_songs').value);
        const threshold = parseFloat(document.getElementById('similarity_threshold').value);

        let payload = {
            max_songs: maxSongs,
            similarity_threshold: threshold,
            included_ids: includedIds,
            excluded_ids: excludedIds
        };

        if (activeTab === 'smart') {
            const filters = getFilters();
            if (filters.length === 0) {
                statusDiv.textContent = 'Please add at least one filter.';
                statusDiv.style.color = 'red';
                return;
            }
            payload.filters = filters;
            payload.match_mode = document.getElementById('match-mode').value;
        } else {
            const playlistName = document.getElementById('playlist_select').value;
            if (!playlistName) {
                statusDiv.textContent = 'Please select a playlist.';
                statusDiv.style.color = 'red';
                return;
            }
            payload.playlist_name = playlistName;
        }

        statusDiv.textContent = 'Searching...';
        statusDiv.style.color = 'blue';

        try {
            const response = await fetch("{{ url_for('extend_playlist_bp.extend_playlist_api') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Search failed');

            // Update Stats
            playlistStats = {
                original: data.playlist_song_count,
                included: data.included_count,
                excluded: data.excluded_count,
                suggested: data.results.length
            };
            updateStatsDisplay();

            displayResults(data.results);

            statusDiv.textContent = `Found ${data.results.length} songs.`;
            statusDiv.style.color = 'green';

            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('stats-container').classList.remove('hidden');
            if (includedIds.length > 0) {
                document.getElementById('playlist-creator').classList.remove('hidden');
            }

        } catch (error) {
            statusDiv.textContent = error.message;
            statusDiv.style.color = 'red';
        }
    }

    function updateStatsDisplay() {
        document.getElementById('stat-original').textContent = playlistStats.original;
        document.getElementById('stat-included').textContent = playlistStats.included;
        document.getElementById('stat-excluded').textContent = playlistStats.excluded;
        document.getElementById('stat-suggested').textContent = playlistStats.suggested;
    }

    function displayResults(results) {
        const wrapper = document.getElementById('results-table-wrapper');
        if (results.length === 0) {
            wrapper.innerHTML = '<p>No similar songs found.</p>';
            return;
        }

        let html = `
            <table class="results-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">Play</th>
                        <th>Title</th>
                        <th>Artist</th>
                        <th>Distance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;

        results.forEach(track => {
            const isIncluded = includedIds.includes(track.item_id);
            const isExcluded = excludedIds.includes(track.item_id);
            let rowClass = isIncluded ? 'included-row' : (isExcluded ? 'excluded-row' : '');

            // Escape strings for safe usage in onclick
            const safeTitle = (track.title || 'Unknown').replace(/'/g, "\\'");
            const safeArtist = (track.song_artist || track.author || 'Unknown').replace(/'/g, "\\'");
            const safeUrl = (track.stream_url || '').replace(/'/g, "\\'");

            html += `
                <tr class="${rowClass}">
                    <td>
                        ${safeUrl ?
                            `<button class="btn-play" onclick="playSong('${safeUrl}', '${safeTitle}', '${safeArtist}')">&#9658;</button>`
                            : '-'}
                    </td>
                    <td>${track.title || 'Unknown'}</td>
                    <td>${track.song_artist || track.author || 'Unknown'}</td>
                    <td>${track.distance ? track.distance.toFixed(4) : 'N/A'}</td>
                    <td>
                        ${isIncluded ? '<span class="status-badge status-included">INCLUDED</span>' :
                          isExcluded ? '<span class="status-badge status-excluded">EXCLUDED</span>' :
                          `<div class="action-buttons">
                               <button class="btn-include" onclick="includeSong('${track.item_id}')">Include</button>
                               <button class="btn-exclude" onclick="excludeSong('${track.item_id}')">Exclude</button>
                           </div>`
                        }
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        wrapper.innerHTML = html;
    }

    // --- Actions ---
    window.includeSong = function(id) {
        if (!includedIds.includes(id)) {
            includedIds.push(id);
            excludedIds = excludedIds.filter(x => x !== id);
            findSimilarSongs();
        }
    };

    window.excludeSong = function(id) {
        if (!excludedIds.includes(id)) {
            excludedIds.push(id);
            includedIds = includedIds.filter(x => x !== id);
            findSimilarSongs();
        }
    };

    document.getElementById('extend-playlist-form').addEventListener('submit', (e) => {
        e.preventDefault();
        // Reset inclusion/exclusion on new primary search
        // But we might want to keep them if refining?
        // The original logic reset them if playlist changed.
        // Here let's keep simple: reset if user explicitly changes source, but refining via 'Find Similar' usually implies keeping context?
        // Actually, re-clicking Find Similar with same settings is usually a "refresh" or "update".
        // If we want to preserve, we shouldn't reset.
        // However, if filters changed drastically, previous includes might be invalid? No, they are just IDs.
        // Let's keep them to allow iterative building.
        findSimilarSongs();
    });

    // --- Playlist Saving ---
    document.getElementById('save-playlist-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('new_playlist_name').value;
        const statusDiv = document.getElementById('playlist-status');

        if (!name || includedIds.length === 0) {
            statusDiv.textContent = 'Please provide a name and include at least one song.';
            return;
        }

        statusDiv.textContent = 'Saving...';
        try {
            // For saving, we need a "source" name. If filters were used, we can just say "Smart Playlist".
            // But the API expects `original_playlist_name`.
            // If we used filters, we don't have an original playlist name.
            // We should update the backend `save_extended_playlist` to not strictly require `original_playlist_name` if we have `included_ids`.
            // Wait, the backend `save_extended_playlist` uses `original_playlist_name` to get `original_ids` and combine them.
            // If we are in Filter mode, there is no "original playlist".
            // The user creates a NEW playlist from the "Included" songs (which are selected from results).
            // If the user wants the *seed* songs too, we currently don't track the seed IDs separately on frontend easily without returning them.
            // For now, let's assume in Filter mode, we ONLY save the `included_ids`.
            // But the backend requires `original_playlist_name`.

            // I need to tweak the backend save function or pass a dummy name.
            // Actually, if I use smart filters, I probably want the result to be just the found songs + includes?
            // Let's assume for now the user selects "Include" on the ones they want.

            // I'll send a special flag or handle it.
            // Ideally, I should update the backend `save_extended_playlist` to accept `filters` too, or just a list of IDs.
            // But `save_extended_playlist` logic is: Original Tracks + Included Tracks.
            // If Source is Playlist: Original = Playlist Tracks.
            // If Source is Filters: Original = Filter Matches (Seed).

            // Simplification: Just pass `included_ids` as the full list? No, backend appends.
            // Let's pass the current `playlist_name` if in playlist mode.
            // If in Filter mode, pass a dummy or empty string, and update backend to handle it.

            let payload = {
                new_playlist_name: name,
                included_ids: includedIds
            };

            if (activeTab === 'playlist') {
                payload.original_playlist_name = document.getElementById('playlist_select').value;
            } else {
                payload.filters = getFilters();
                payload.match_mode = document.getElementById('match-mode').value;
            }

            const response = await fetch("{{ url_for('extend_playlist_bp.save_extended_playlist') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (response.ok) {
                statusDiv.textContent = 'Saved successfully!';
                statusDiv.style.color = 'green';
                loadPlaylists(); // Refresh list
            } else {
                throw new Error(data.error);
            }
        } catch (e) {
            statusDiv.textContent = e.message;
            statusDiv.style.color = 'red';
        }
    });

    // --- Player Logic ---
    window.playSong = function(url, title, artist) {
        if (!url) return;

        const audio = document.getElementById('audio-element');
        const player = document.getElementById('web-player');

        player.classList.remove('hidden');
        document.getElementById('player-title').textContent = title;
        document.getElementById('player-artist').textContent = artist;

        audio.src = url;
        audio.play();
        document.getElementById('play-pause-btn').innerHTML = '&#10074;&#10074;'; // Pause symbol
    };

    window.togglePlay = function() {
        const audio = document.getElementById('audio-element');
        const btn = document.getElementById('play-pause-btn');
        if (audio.paused) {
            audio.play();
            btn.innerHTML = '&#10074;&#10074;';
        } else {
            audio.pause();
            btn.innerHTML = '&#9658;';
        }
    };

    window.seek = function(seconds) {
        const audio = document.getElementById('audio-element');
        audio.currentTime += seconds;
    };

    function updateProgress() {
        const audio = document.getElementById('audio-element');
        const current = audio.currentTime;
        const duration = audio.duration;

        if (isNaN(duration)) return;

        document.getElementById('current-time').textContent = formatTime(current);
        document.getElementById('duration').textContent = formatTime(duration);

        const pct = (current / duration) * 100;
        document.getElementById('progress-fill').style.width = `${pct}%`;
    }

    window.seekTo = function(e) {
        const audio = document.getElementById('audio-element');
        const bar = e.currentTarget;
        const pct = e.offsetX / bar.offsetWidth;
        audio.currentTime = pct * audio.duration;
    };

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return `${m}:${sec.toString().padStart(2, '0')}`;
    }

</script>
{% endblock %}
